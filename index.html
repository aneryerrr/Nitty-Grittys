<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nitty Gritty</title>

  <!-- Strong no-cache for the HTML itself -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="icon" href="./logo-ng.png" type="image/png" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="root"></div>

  <!-- Google Identity Services -->
  <script>
    window.GOOGLE_CLIENT_ID =
      "579461879935-qaj9nta2pfbrn17ss5idu2k39p4joir4.apps.googleusercontent.com";
  </script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Deploy version: bump this on each release -->
  <script>
    window.__NG_BUILD = "2025-11-05.08"; // <- update this string when you push
  </script>

  <!-- Babel standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Robust bootstrap: compile script.js with Babel and inject as plain JS -->
  <script>
    (async function boot() {
      const version = "?v=" + (window.__NG_BUILD || ("dev-" + Date.now()));

      // Load CSS with version param to defeat CDN caches
      const css = document.createElement("link");
      css.rel = "stylesheet";
      css.href = "./styles.css" + version;
      document.head.appendChild(css);

      // Safety shim so legacy bundles cannot crash the page during CDN churn
      if (typeof window.DetailedStats === "undefined") {
        window.DetailedStats = function () { return React.createElement("div"); };
      }

      // (Optional) nuke any old app caches if present
      try {
        if ("caches" in window) {
          const keys = await caches.keys();
          for (const k of keys) if (k.startsWith("ng-")) await caches.delete(k);
        }
      } catch {}

      // Fetch -> transpile -> inject
      try {
        const res = await fetch("./script.js" + version, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const src = await res.text();
        const out = Babel.transform(src, { presets: ["env", "react"] }).code;

        const s = document.createElement("script");
        s.type = "text/javascript";
        s.text = out;
        document.body.appendChild(s);

        try { localStorage.setItem("__NG_BUILD_LAST", String(window.__NG_BUILD||"dev")); } catch {}
      } catch (e) {
        const box = document.createElement("pre");
        box.style.cssText = "white-space:pre-wrap;color:#fecaca;background:#450a0a;padding:12px;border-radius:8px;margin:12px";
        box.textContent = "Failed to bootstrap app: " + (e && (e.stack || e.message || e));
        document.body.appendChild(box);
      }
    })();
  </script>
</body>
</html>
